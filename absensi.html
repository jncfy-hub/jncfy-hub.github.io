<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Absensi QR Code</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
      body {
        background: linear-gradient(180deg, #f8f9fa, #e9ecef);
        min-height: 100vh;
      }
      h3 {
        font-weight: 600;
        color: #0d6efd;
      }
      #reader {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }
      footer {
        font-size: 0.9rem;
        color: #666;
        margin-top: 2rem;
      }
    </style>
  </head>
  <body class="text-center">
    <div class="container py-5">
      <img src="https://cdn-icons-png.flaticon.com/512/2720/2720565.png" alt="QR Icon" width="80" class="mb-3">
      <h3 class="mb-4">ðŸ“· Scan QR Code Absensi</h3>
      <div id="reader" class="mx-auto"></div>
      <div id="hasil" class="mt-4"></div>
    </div>

    <footer>
      <p>Â© 2025 JNC Edukasi Â· Absensi Online</p>
    </footer>

    <script>
      const urlScript = "https://script.google.com/macros/s/AKfycbwpVdZeuRZSgqzVeWcpYLjpwdHg8JODzO55OWUe1d9J5DsUa4J11YhK537eQOXWOp8XPQ/exec"; 
      const html5QrCode = new Html5Qrcode("reader");
      function getScannerSize() {
        const width = window.innerWidth;
        if (width < 400) return width * 0.9;
        if (width < 768) return 300;
        return 350;
      }

      function startScanner() {
        const qrboxSize = getScannerSize();
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: qrboxSize },
          onScanSuccess
        ).catch(err => console.error("Camera start error:", err));
      }

      function onScanSuccess(decodedText) {
        html5QrCode.stop().then(() => {
          document.getElementById("hasil").innerHTML = `
            <div class="alert alert-info mt-3">
              Data terbaca:<br><b>${decodedText}</b>
            </div>
          `;
          try {
            const data = JSON.parse(decodedText);

            Swal.fire({
              title: "Mengirim data...",
              text: "Mohon tunggu sebentar",
              didOpen: () => Swal.showLoading(),
              allowOutsideClick: false
            });

            fetch(urlScript, {
              method: "POST",
              body: JSON.stringify(data)
            })
              .then(r => r.text())
              .then(res => {
                if (res.startsWith("OK")) {
                  const pesan = res.replace("OK: ", "");
                  Swal.fire({
                    icon: "success",
                    title: "OK âœ…",
                    text: pesan,
                    timer: 2000,
                    showConfirmButton: false
                  });
                  setTimeout(() => {
                    document.getElementById("hasil").innerHTML = "";
                    startScanner();
                  }, 2000);
                } else if (res.startsWith("GAGAL")) {
                  const pesan = res.replace("GAGAL: ", "");
                  Swal.fire({
                    icon: "warning",
                    title: "Tidak Bisa Absen!",
                    text: pesan
                  }).then(() => startScanner());
                } else {
                  Swal.fire("Error", res, "error").then(() => startScanner());
                }
              })
              .catch(() => {
                Swal.fire("Gagal!", "Tidak dapat mengirim data ke server!", "error")
                  .then(() => startScanner());
              });
          } catch (e) {
            Swal.fire("QR Code Error", "Format QR tidak valid!", "error")
              .then(() => startScanner());
          }
        });
      }
      window.addEventListener("load", startScanner);
      window.addEventListener("resize", () => {
        html5QrCode.stop().then(() => startScanner());
      });
    </script>
  </body>
</html>
