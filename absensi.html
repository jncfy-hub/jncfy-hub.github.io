<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <title>Smart Presence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        overflow-x: hidden;
        background: linear-gradient(135deg, #b1ffd6, #cce5ff);
        font-family: "Poppins", sans-serif;
        display: flex;
        flex-direction: column;
        animation: fadeIn 1s ease-in;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .navbar {
        background: #fff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        flex-shrink: 0;
      }

      .navbar-brand img {
        width: 35px;
        margin-right: 8px;
      }

      .nav-link {
        font-weight: 500;
        color: #555 !important;
        transition: color 0.3s ease;
      }

      .nav-link:hover, .nav-link.active {
        color: #0d6efd !important;
      }

      .hero {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 10px;
      }

      .hero img {
        width: 120px;
        margin-bottom: 15px;
        transition: transform 0.3s ease;
      }

      .hero img:hover {
        transform: scale(1.05);
      }

      .btn-main {
        padding: 12px 28px;
        font-size: 1.1rem;
        border-radius: 30px;
        transition: all 0.3s ease;
      }

      .btn-main:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      }

      #btnRiwayat {
        border-width: 2px;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      #btnRiwayat:hover {
        background-color: #0d6efd;
        color: white;
        transform: scale(1.05);
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      }

      footer {
        text-align: center;
        background: #fff;
        padding: 3px 0;
        font-size: 0.9rem;
        color: #666;
        box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
      }

      #reader {
        width: 100%;
        max-width: 500px;
        aspect-ratio: 3/4;
        margin: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }

      #clock {
        letter-spacing: 1px;
        background: rgba(255, 255, 255, 0.7);
        padding: 6px 16px;
        border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }

      @media (max-width: 768px) {
        #reader {
          width:100%;   
          height: 60vh;  
          margin: 0 auto;
          position: relative;
          left: 50%;
          transform: translateX(-50%); 
          overflow: hidden;
        }
      }

      #startBtn {
        padding: 12px 24px;
        font-size: 1.1rem;
        transition: all 0.3s ease;
      }

      #startBtn:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
      <div class="container">
        <a class="navbar-brand d-flex align-items-center" href="#">
          <img src="https://lh3.googleusercontent.com/z758kRDT4zZpMf7_oi7p8gikCZtBEc9LLL5Uokunegi69Gi2swuS_bP8MqNi83Of8KeS9ytOCHqOUafSxQ" alt="Logo">
          <span class="fw-bold text-primary">Edu Media 24</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link active" href="#">
                <i class="fa-solid fa-house me-1"></i> Home
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="menuDataSiswa">
                <i class="fa-solid fa-users me-1"></i> Data Siswa
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="menuRiwayat">
                <i class="fa-solid fa-clock-rotate-left me-1"></i> Riwayat
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="menuLogin">
                <i class="fa-solid fa-right-to-bracket me-1"></i> Login
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

   <section class="hero">
      <img src="https://cdn-icons-png.flaticon.com/512/2720/2720565.png" alt="Smart Presence Logo">
      <div id="clock" class="fw-bold text-secondary mb-2" style="font-size: 1.2rem;"></div>
      <h1 class="fw-bold text-primary">Smart Presence</h1>
      <p class="text-muted">
        Sistem absensi modern berbasis QR Code untuk kehadiran yang cepat, mudah, dan efisien.
      </p>
      <div class="d-flex flex-column align-items-center gap-3">
        <button class="btn btn-primary btn-main" data-bs-toggle="modal" data-bs-target="#passwordModal">
          <i class="fa-solid fa-qrcode me-2"></i> Masuk ke Aplikasi
        </button>
        <button class="btn btn-outline-primary btn-main" id="btnRiwayat">
          <i class="fa-solid fa-clock-rotate-left me-2"></i> Riwayat Absensi
        </button>
      </div>
    </section>

    <div class="modal fade" id="passwordModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
          <div class="modal-header">
            <h5 class="modal-title fw-bold text-primary">
              <i class="fa-solid fa-lock me-2"></i> Verifikasi Akses Absensi
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="form-floating">
              <input type="password" class="form-control" id="absenPassword" placeholder="Password">
              <label for="absenPassword">Masukkan password</label>
            </div>
            <div id="errorMsg" class="text-danger mt-2" style="display:none;">Password salah, coba lagi!</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="btnMasuk">
              <i class="fa-solid fa-right-to-bracket me-2"></i> Masuk
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="absensiModal" tabindex="-1">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content text-center" style="background: linear-gradient(135deg, #cce5ff, #b1ffd6);">
          <div class="modal-body">
            <img src="https://cdn-icons-png.flaticon.com/512/2720/2720565.png" alt="Logo" style="width:100px; margin-bottom:10px;">
            <h3 class="fw-bold text-primary mb-4">ðŸ“· Smart Presence</h3>
            <button id="startBtn" class="btn btn-primary mb-4">
              <i class="fa-solid fa-qrcode me-2"></i> Scan QR Code
            </button>
            <div id="reader" class="mx-auto"></div>
            <div id="hasil" class="mt-4"></div>
          </div>
          <div class="modal-footer justify-content-center border-0">
            <button type="button" class="btn btn-secondary" id="btnLogout">
              <i class="fa-solid fa-right-from-bracket me-2"></i> Logout
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow">
        <div class="modal-header">
          <h5 class="modal-title fw-bold text-primary"><i class="fa-solid fa-lock me-2"></i>Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="form-floating mb-3">
            <input type="text" id="loginUsername" class="form-control" placeholder="Username">
            <label for="loginUsername">Masukkan Username</label>
          </div>
          <div class="form-floating mb-3">
            <input type="password" id="loginPassword" class="form-control" placeholder="Password">
            <label for="loginPassword">Masukkan Password</label>
          </div>
          <div id="errorMsg" class="text-danger" style="display:none;">Username atau Password salah!</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="btnLoginModal"><i class="fa-solid fa-right-to-bracket me-2"></i>Masuk</button>
        </div>
      </div>
     </div>
   </div>

<footer>
  <p class="mt-3">Â© 2025 Edu Media 24 - Smart Presence | Powered by JNC Edukasi</p>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const urlLogin = "https://script.google.com/macros/s/AKfycbwpVdZeuRZSgqzVeWcpYLjpwdHg8JODzO55OWUe1d9J5DsUa4J11YhK537eQOXWOp8XPQ/exec";
  const menuLogin = document.getElementById("menuLogin");
  const menuDataSiswa = document.getElementById("menuDataSiswa");
  const menuRiwayat = document.getElementById("menuRiwayat");
  const loginModalEl = document.getElementById("loginModal");
  const loginModal = new bootstrap.Modal(loginModalEl);

  document.addEventListener("DOMContentLoaded", () => {
    const isLoggedIn = sessionStorage.getItem("isLoggedIn") === "true";
    updateMenu(isLoggedIn);
  });

  menuLogin.addEventListener("click", () => {
    if (menuLogin.textContent.includes("Logout")) {
      Swal.fire({
        title: "Yakin logout?",
        text: "Anda akan keluar dari akun ini.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Logout",
        cancelButtonText: "Batal"
      }).then(result => {
        if (result.isConfirmed) {
          sessionStorage.removeItem("isLoggedIn");
          sessionStorage.removeItem("username");
          updateMenu(false);
          Swal.fire("Logout berhasil", "", "success");
        }
      });
    } else {
      loginModal.show();
    }
  });

  document.getElementById("btnLoginModal").addEventListener("click", async () => {
    const username = document.getElementById("loginUsername").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    const errorMsg = document.getElementById("errorMsg");

    if (!username || !password) {
      errorMsg.style.display = "block";
      errorMsg.textContent = "Silakan isi semua kolom!";
      return;
    }

    try {
      const res = await fetch(`${urlLogin}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
      const data = await res.json();

      if (data.result === "success") {
        sessionStorage.setItem("isLoggedIn", "true");
        sessionStorage.setItem("username", username);
        updateMenu(true);
        loginModal.hide();
        Swal.fire("Login Berhasil!", `Selamat datang, ${username}`, "success");
      } else {
        errorMsg.style.display = "block";
        errorMsg.textContent = "Username atau Password salah!";
      }
    } catch (err) {
      Swal.fire("Error", "Gagal menghubungkan ke server.", "error");
    }
  });

  function updateMenu(isLoggedIn) {
    if (isLoggedIn) {
      menuDataSiswa.style.display = "block";
      menuRiwayat.style.display = "block";
      menuLogin.innerHTML = '<i class="fa-solid fa-right-from-bracket me-1"></i> Logout';
    } else {
      menuDataSiswa.style.display = "none";
      menuRiwayat.style.display = "none";
      menuLogin.innerHTML = '<i class="fa-solid fa-right-to-bracket me-1"></i> Login';
    }
  }

  const PASSWORD_ABSENSI = "123";
  const urlScript = "https://script.google.com/macros/s/AKfycbwpVdZeuRZSgqzVeWcpYLjpwdHg8JODzO55OWUe1d9J5DsUa4J11YhK537eQOXWOp8XPQ/exec";
  let html5QrCode;
  let isScannerActive = false;
  let currentCamera = "environment";

  const passwordModalEl = document.getElementById("passwordModal");
  const absensiModalEl = document.getElementById("absensiModal");
  const absensiModal = new bootstrap.Modal(absensiModalEl);

  document.getElementById("btnMasuk").addEventListener("click", function() {
    const inputPassword = document.getElementById("absenPassword").value;
    const errorMsg = document.getElementById("errorMsg");
    if (inputPassword === PASSWORD_ABSENSI) {
      errorMsg.style.display = "none";
      this.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i> Memproses...';
      this.disabled = true;
      setTimeout(() => {
        bootstrap.Modal.getInstance(passwordModalEl).hide();
        sessionStorage.setItem("isLoggedIn", "true");
        sessionStorage.setItem("isInAbsensi", "true");
        absensiModal.show();
        this.innerHTML = '<i class="fa-solid fa-right-to-bracket me-2"></i> Masuk';
        this.disabled = false;
      }, 800);
    } else {
      errorMsg.style.display = "block";
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    const isInAbsensi = sessionStorage.getItem("isInAbsensi");
    if (isInAbsensi === "true") absensiModal.show();
  });

  document.getElementById("btnLogout").addEventListener("click", () => {
    Swal.fire({
      title: "Yakin logout?",
      text: "Anda akan keluar dari mode absensi.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Ya, logout",
      cancelButtonText: "Batal"
    }).then((result) => {
      if (result.isConfirmed) {
        sessionStorage.removeItem("isLoggedIn");
        sessionStorage.removeItem("isInAbsensi");
        location.reload();
      }
    });
  });

  function getScannerSize() {
    const width = window.innerWidth;
    const height = window.innerHeight;
    return width < 768 ? Math.min(width * 0.9, height * 0.7) : 400;
  }

  async function startScanner() {
    if (isScannerActive) return;
    isScannerActive = true;

    document.getElementById("reader").style.display = "block";
    document.getElementById("startBtn").style.display = "none";

    try {
      html5QrCode = new Html5Qrcode("reader");
      await html5QrCode.start(
        { facingMode: currentCamera },
        { fps: 10, qrbox: getScannerSize() },
        onScanSuccess,
        onScanFailure
      );
    } catch (err) {
      Swal.fire({
        icon: "error",
        title: "Gagal membuka kamera",
        text: "Pastikan izin kamera diaktifkan dan tidak digunakan oleh aplikasi lain.",
        confirmButtonText: "Coba Lagi"
      }).then(() => {
        isScannerActive = false;
        document.getElementById("reader").style.display = "none";
        document.getElementById("startBtn").style.display = "block";
      });
    }
  }

  async function stopScanner() {
    if (html5QrCode) {
      try {
        await html5QrCode.stop();
        await html5QrCode.clear();
      } catch (e) {}
    }
    isScannerActive = false;
  }

  async function switchCamera() {
    currentCamera = currentCamera === "environment" ? "user" : "environment";
    await stopScanner();
    startScanner();
    Swal.fire("Kamera diganti!", `Mode: ${currentCamera}`, "success");
  }

  function onScanSuccess(decodedText) {
  stopScanner();

  try {
    const data = JSON.parse(decodedText);
    document.getElementById("hasil").innerHTML = `
      <div class="alert alert-info mt-3 text-start">
        <h5 class="fw-bold text-primary mb-2">Data Terbaca:</h5>
        <p class="mb-1"><b>Nama:</b> ${data.nama || "-"}</p>
        <p class="mb-1"><b>Jenis Kelamin:</b> ${data.jk || data.jenisKelamin || "-"}</p>
        <p class="mb-1"><b>NIS:</b> ${data.nis || data.nisn || "-"}</p>
        <p class="mb-1"><b>Kelas:</b> ${data.kelas || "-"}</p>
      </div>
    `;
    Swal.fire({
      title: "Mengirim data...",
      text: "Mohon tunggu sebentar",
      didOpen: () => Swal.showLoading(),
      allowOutsideClick: false
    });

    fetch(urlScript, {
      method: "POST",
      body: JSON.stringify(data)
    })
      .then(r => r.text())
      .then(res => {
        if (res.startsWith("OK")) {
          Swal.fire({
            icon: "success",
            title: "OK âœ…",
            text: res.replace("OK: ", ""),
            timer: 2000,
            showConfirmButton: false
          });
          setTimeout(() => {
            document.getElementById("hasil").innerHTML = "";
            startScanner();
          }, 2000);
        } else {
          Swal.fire("Gagal!", res, "error").then(() => startScanner());
        }
      })
      .catch(() => {
        Swal.fire("Gagal!", "Tidak dapat mengirim data ke server!", "error").then(() => startScanner());
      });
    } catch (e) {
      Swal.fire("QR Code Error", "Format QR tidak valid!", "error").then(() => startScanner());
    }
  }

  function onScanFailure(error) {
  }

  document.getElementById("startBtn").addEventListener("click", startScanner);
  const switchBtn = document.createElement("button");
  switchBtn.className = "btn btn-outline-secondary mt-3";
  switchBtn.innerHTML = '<i class="fa-solid fa-camera-rotate me-2"></i> Ganti Kamera';
  switchBtn.addEventListener("click", switchCamera);
  document.getElementById("absensiModal").querySelector(".modal-body").appendChild(switchBtn);

  function updateClock() {
    const now = new Date();
    const options = { hour12: false };
    document.getElementById('clock').textContent = now.toLocaleTimeString('id-ID', options);
  }
  setInterval(updateClock, 1000);
  updateClock();
</script>
</body>
</html>
