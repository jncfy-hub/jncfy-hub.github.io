<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
  <title>Ujian Online - JNC Edukasi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    background-color: #f8f9fa;
    font-family: 'Poppins', sans-serif;
    overflow: hidden;
  }

  ::-webkit-scrollbar { display: none; }

  #welcomeScreen {
    position: fixed; inset: 0;
    background: linear-gradient(135deg, #007bff, #00c3ff);
    color: white;
    display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    text-align: center; z-index: 20;
  }

  #welcomeScreen img {
    width: 120px; height: 120px;
    margin-bottom: 1rem; border-radius: 50%;
    background: white; padding: 10px;
    box-shadow: 0 0 20px rgba(255,255,255,0.5);
  }

  #loginScreen {
    position: fixed; inset: 0;
    background: linear-gradient(135deg, #007bff, #00c3ff);
    display: none; flex-direction: column;
    justify-content: center; align-items: center;
    color: white; text-align: center; z-index: 10;
  }

  #loginBox .input-group {
    background: rgba(255, 255, 255, 0.85);
    border-radius: 5px;
    padding: 4px 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
  }

  #loginBox .input-group:focus-within {
    box-shadow: 0 0 10px rgba(0, 195, 255, 0.6);
  }

  #loginBox .form-control:focus {
    box-shadow: none;
    border-color: transparent;
  }

  #examContainer {
    display:none; flex-direction:row;
    width:100vw; height:100vh; overflow:hidden;
    background:#f8f9fa;
  }

  .student-info {
    font-size: 0.9rem;   
    line-height: 1.4;  
    color: #333;   
    margin-bottom: 0.8rem; 
  }
  .student-info strong {
    color: #007bff; 
  }

  .pdf-viewer { flex:1; background:#fff; border-right:3px solid #e9ecef; }
  .pdf-viewer iframe { width:100%; height:100%; border:none; }

  .answer-section {
    width:29%; background:#fff; padding:1.5rem;
    display:flex; flex-direction:column;
    justify-content:space-between; overflow-y:auto;
  }

  .question-row > span {
    display: inline-block;
    width: 10px; 
    min-width: 10px;
    text-align: right;  
    margin-right: 0.2rem; 
  }

  .question-row { display:flex; align-items:center; gap:1.5rem; margin-bottom:0.8rem; font-size:1rem; }
  .options { display:flex; gap:1rem; }
  .options input[type="radio"] { display:none; }

  .option-dot {
    display:flex; align-items:center; justify-content:center;
    width:23px; height:23px;
    border:2px solid #007bff; border-radius:50%;
    color:#007bff; font-weight:600; font-size:0.9rem;
    transition:all 0.25s ease;
  }

  .options label:hover .option-dot { border-color:#00c3ff; color:#00c3ff; box-shadow:0 0 5px rgba(0,195,255,0.5); }
  .options input[type="radio"]:checked + .option-dot {
    background-color:#007bff; color:#fff; box-shadow:0 0 6px rgba(0,123,255,0.4); transform:scale(1.05);
  }

  .submit-btn { border-radius:30px; font-weight:600; transition:all 0.3s ease; }
  .submit-btn:hover { transform:scale(1.05); box-shadow:0 4px 12px rgba(0,123,255,0.3); }

  #landscapeWarning {
    display:none; position:fixed; inset:0;
    background:rgba(0,0,0,0.85); color:white;
    justify-content:center; align-items:center;
    text-align:center; font-size:1.2rem;
    padding:20px; z-index:9999; flex-direction:column;
  }

  #landscapeWarning i {
    font-size:3.5rem;
    color:#00c3ff;
    margin-bottom:1rem;
    animation: rotatePhone 2s infinite linear;
  }

  @keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-6px); }
  40%, 80% { transform: translateX(6px); }
}
.shake {
  animation: shake 0.3s;
}


  @keyframes rotatePhone {
    0% { transform: rotate(0deg); }
    50% { transform: rotate(90deg); }
    100% { transform: rotate(0deg); }
  }
</style>
</head>
<body>
<div id="welcomeScreen">
    <img src="https://lh3.googleusercontent.com/z758kRDT4zZpMf7_oi7p8gikCZtBEc9LLL5Uokunegi69Gi2swuS_bP8MqNi83Of8KeS9ytOCHqOUafSxQ" alt="Logo JNC">
    <h1>Welcome To Online Examination</h1>
    <button id="startBtn" class="btn btn-light px-4 py-2 fw-bold"><i class="fa-solid fa-play"></i> Start Test</button>
  </div>
  <div id="loginScreen">
   <div id="loginBox">
    <div class="login-icon mb-2">
      <i class="fa-solid fa-user-graduate fa-3x text-white"></i>
    </div>
    <h3 class="fw-semibold mb-4">Masuk Ujian</h3>
    <form id="loginForm">
      <div class="input-group mb-2">
        <span class="input-group-text bg-white border-0">
          <i class="fa-solid fa-id-card text-primary"></i>
        </span>
        <input type="text" id="nis" class="form-control border-0" placeholder="NIS / NISN" maxlength="10" inputmode="numeric" required>
      </div>
      <small id="nisError" class="text-danger d-none">Anda sudah mengikuti ujian ini.</small>
      <div class="input-group mb-2">
        <span class="input-group-text bg-white border-0">
          <i class="fa-solid fa-user text-primary"></i>
        </span>
        <input type="text" id="nama" class="form-control border-0" placeholder="Nama Lengkap" readonly required>
      </div>
      <div class="input-group mb-2">
        <span class="input-group-text bg-white border-0">
          <i class="fa-solid fa-school text-primary"></i>
        </span>
        <input type="text" id="kelas" class="form-control border-0" placeholder="Kelas" readonly required>
      </div>
      <div class="input-group mb-2" style="display:none">
        <span class="input-group-text bg-white border-0">
          <i class="fa-solid fa-book text-primary"></i>
        </span>
        <input type="text" id="mapel" class="form-control border-0" placeholder="Mata Pelajaran" readonly required>
      </div>
      <div class="input-group mb-2">
        <span class="input-group-text bg-white border-0">
          <i class="fa-solid fa-unlock text-primary"></i>
        </span>
        <input type="text" id="password" class="form-control border-0" placeholder="Password" required>
      </div>
      <small id="passwordError" class="text-danger d-none">Password salah, coba lagi!</small>
      <button type="submit" id="kirimJawaban" class="btn btn-light w-100 mt-2 fw-semibold">
        <i class="fa-solid fa-arrow-right-to-bracket me-1"></i> Mulai Ujian
      </button>
    </form>
   </div>
 </div>

  <div id="examContainer">
    <div class="pdf-viewer">
      <iframe  id="pdfFrame" src="" allow="autoplay"></iframe>
    </div>
    <div class="answer-section">
      <div>
        <h6 class="text-center fw-bold"><i class="fa-solid fa-pen"></i> Lembar Jawaban</h6>
        <h6 id="timer" class="text-center text-danger fw-bold">Waktu Tersisa: 120:00</h6>
         <p class="student-info mb-3">
          <strong>Nama:</strong> <span id="userName"></span><br>
          <strong>Kelas:</strong> <span id="userClass"></span>
        </p>
       <form id="examForm"></form>
      </div>
      <div class="d-flex justify-content-center mt-3">
      <button id="submitBtn" class="btn btn-primary w-100 py-2 submit-btn"><i class="fa-solid fa-paper-plane"></i> Kirim Jawaban</button>
      </div>
    </div>
  </div>

  <div id="landscapeWarning">
    <i class="fa-solid fa-rotate"></i>
    <p>ðŸ”„ Silakan ubah orientasi ke mode <strong>landscape</strong> untuk melanjutkan ujian.</p>
    <button id="okLandscapeBtn" class="btn btn-primary mt-3 px-4 py-2 fw-semibold">
      <i class="fa-solid fa-check"></i> OK
    </button>
  </div>

  <script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwbsrC-FVv-ZO6OBHklmOcRuGxSz2bP1TGxtK9gfwMp8m08xAeHGl5LzkuGy925PEsE/exec";
  const welcomeScreen = document.getElementById("welcomeScreen");
  const startBtn = document.getElementById("startBtn");
  const loginScreen = document.getElementById("loginScreen");
  const loginForm = document.getElementById("loginForm");
  const examContainer = document.getElementById("examContainer");
  const landscapeWarning = document.getElementById("landscapeWarning");
  const timerDisplay = document.getElementById("timer");
  let mapelPassword = ""; 
  let wakeLock = null;
  let timerInterval;
  let remainingTime = 120 * 60;

  async function enableWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
      }
    } catch (err) {
      console.warn("Gagal mengaktifkan wake lock:", err);
    }
  }

  function disableWakeLock() {
    if (wakeLock !== null) {
      wakeLock.release();
      wakeLock = null;
    }
  }

  async function goFullscreen() {
    const elem = document.documentElement;
    if (!document.fullscreenElement) {
      try {
        if (elem.requestFullscreen) await elem.requestFullscreen();
        else if (elem.webkitRequestFullscreen) await elem.webkitRequestFullscreen();
        else if (elem.msRequestFullscreen) await elem.msRequestFullscreen();
      } catch (err) {
        console.warn("Fullscreen gagal:", err);
      }
    }
  }

  function checkOrientation() {
    if (examContainer.style.display === "flex") {
      if (window.matchMedia("(orientation: portrait)").matches) {
        landscapeWarning.style.display = "flex";
        examContainer.style.display = "none";
      } else {
        landscapeWarning.style.display = "none";
        examContainer.style.display = "flex";
      }
    }
  }

 window.addEventListener("orientationchange", checkOrientation);
  document.getElementById("okLandscapeBtn").addEventListener("click", async () => {
    try {
      if (screen.orientation && screen.orientation.lock) {
        await screen.orientation.lock("landscape");
      }
    } catch (err) {
      console.warn("Tidak bisa mengunci orientasi:", err);
    }
    landscapeWarning.style.display = "none";
    examContainer.style.display = "flex";
  });

  startBtn.addEventListener("click", async () => {
    await goFullscreen();
    welcomeScreen.style.display = "none";
    loginScreen.style.display = "flex";
  });

  if (localStorage.getItem("examEndTime")) {
    const endTime = parseInt(localStorage.getItem("examEndTime"));
    const now = Math.floor(Date.now() / 1000);
    remainingTime = Math.max(0, endTime - now);
  }

  function startTimer(duration) {
    clearInterval(timerInterval);
    const endTime = Math.floor(Date.now() / 1000) + duration;
    localStorage.setItem("examEndTime", endTime);
    timerInterval = setInterval(() => {
      const now = Math.floor(Date.now() / 1000);
      remainingTime = Math.max(0, endTime - now);
      const minutes = String(Math.floor(remainingTime / 60)).padStart(2, "0");
      const seconds = String(remainingTime % 60).padStart(2, "0");
      timerDisplay.textContent = `Waktu Tersisa: ${minutes}:${seconds}`;

      if (remainingTime <= 0) {
        clearInterval(timerInterval);
        resetTimer();
        localStorage.removeItem("examEndTime");
        Swal.fire({
          title: "Waktu Habis!",
          text: "Jawaban dikirim otomatis.",
          confirmButtonText: "OK",
          confirmButtonColor: "#007bff"
        }).then(() => {
          const form = document.getElementById("examForm");
          form.reset();
          disableWakeLock();
          document.exitFullscreen();
          examContainer.style.display = "none";
          loginScreen.style.display = "none";
          welcomeScreen.style.display = "flex";
          document.getElementById("nis").value = "";
          document.getElementById("nama").value = "";
          document.getElementById("kelas").value = "";
          document.getElementById("password").value = "";
          document.getElementById("userName").textContent = "";
          document.getElementById("userClass").textContent = "";
        });
      }
    }, 1000);
  }

  function resumeTimer() {
    if (localStorage.getItem("examEndTime")) {
      const endTime = parseInt(localStorage.getItem("examEndTime"));
      const now = Math.floor(Date.now() / 1000);
      remainingTime = Math.max(0, endTime - now);
      startTimer(remainingTime);
    } else {
      startTimer(remainingTime);
    }
  }

  function resetTimer() {
    clearInterval(timerInterval);
    remainingTime = 120 * 60;
    timerDisplay.textContent = "Waktu Tersisa: 120:00";
    localStorage.removeItem("examEndTime");
  }

  document.getElementById("submitBtn").addEventListener("click", async () => {
    const form = document.getElementById("examForm");
    const totalSoal = form.querySelectorAll(".question-row").length;
    const data = new FormData(form);
    const unanswered = [];

    for (let i = 1; i <= totalSoal; i++) {
      if (!data.get(`soal${i}`)) unanswered.push(i);
    }

    if (unanswered.length > 0) {
      Swal.fire({
        title: "Tinjau kembali!",
        html: `Belum dijawab soal nomor: <b>${unanswered.join(", ")}</b>`,
        confirmButtonText: "OK",
        confirmButtonColor: "#007bff"
      });
      return;
    }

    Swal.fire({
      title: "Yakin ingin kirim jawaban?",
      showCancelButton: true,
      confirmButtonText: "Ya, kirim!",
      cancelButtonText: "Batal",
      confirmButtonColor: "#007bff",
      cancelButtonColor: "#dc3545"
    }).then(async (result) => {
      if (result.isConfirmed) {
        Swal.fire({
          title: "Sedang mengirim...",
          text: "Harap tunggu beberapa detik.",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });
        const nis = document.getElementById("nis").value.trim();
        const nama = document.getElementById("nama").value.trim();
        const kelas = document.getElementById("kelas").value.trim();
        const mapel = document.getElementById("mapel").value.trim();
        const jawaban = [];
        for (let i = 1; i <= totalSoal; i++) {
          jawaban.push(data.get(`soal${i}`));
        }
        try {
          const response = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({
              action: "submitJawaban",
              nis,
              nama,
              kelas,
              mapel,
              jawaban
            })
          });
          const result = await response.json();
          if (result.status === "success") {
            Swal.fire({
              icon: "success",
              title: "Jawaban Tersimpan!",
              html: `Skor: <b>${result.skor}</b><br>Kategori: <b>${result.kategori}</b>`,
              confirmButtonColor: "#007bff"
            }).then(() => {
              form.reset();
              disableWakeLock();
              document.exitFullscreen();
              resetTimer();
              examContainer.style.display = "none";
              loginScreen.style.display = "none";
              welcomeScreen.style.display = "flex";
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Gagal Mengirim!",
              text: result.message || "Terjadi kesalahan.",
              confirmButtonColor: "#007bff"
            });
          }
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: err.message,
            confirmButtonColor: "#007bff"
          });
        }
      }
    });
  });

  document.addEventListener("fullscreenchange", () => {
    if (!document.fullscreenElement) {
      disableWakeLock();
      examContainer.style.display = "none";
      loginScreen.style.display = "flex";
      welcomeScreen.style.display = "none";
      const form = document.getElementById("examForm");
      form.reset();
      document.getElementById("nis").value = "";
      document.getElementById("nama").value = "";
      document.getElementById("kelas").value = "";
      document.getElementById("mapel").value = "";
      document.getElementById("password").value = "";
    }
  });

  window.addEventListener("beforeunload", () => {
    const form = document.getElementById("examForm");
    if (form) form.reset();
  });

  document.addEventListener("DOMContentLoaded", async function () {
  const nisInput = document.getElementById("nis");
  const namaInput = document.getElementById("nama");
  const kelasInput = document.getElementById("kelas");
  const mapelInput = document.getElementById("mapel");
  const pdfFrame = document.querySelector(".pdf-viewer iframe");
  const passwordInput = document.getElementById("password");
  const submitBtn = document.querySelector("#loginForm button[type='submit']");
  let mapelPassword = "";
  let fetchTimeout;

  const nisError = document.getElementById("nisError");
  const passwordError = document.getElementById("passwordError");

  passwordInput.disabled = true;
  passwordInput.style.cursor = "not-allowed";
  submitBtn.disabled = true;
  submitBtn.style.opacity = "0.6";
  submitBtn.style.cursor = "not-allowed";

  nisInput.addEventListener("input", async function () {
    const nisValue = this.value.trim();
    namaInput.value = "";
    kelasInput.value = "";
    mapelInput.value = "";
    pdfFrame.src = "";
    passwordInput.value = "";
    mapelPassword = "";
    submitBtn.disabled = true;
    submitBtn.style.opacity = "0.6";
    nisError.classList.add("d-none");

    if (nisValue.length < 5) return;

    clearTimeout(fetchTimeout);
    const currentNIS = nisValue;
    fetchTimeout = setTimeout(async () => {
      try {
        namaInput.value = "Memuat data...";
        namaInput.style.color = "#0d6efd";
        namaInput.style.fontStyle = "italic";
        const response = await fetch(`${API_URL}?nis=${encodeURIComponent(currentNIS)}`);
        const data = await response.json();
        if (nisInput.value.trim() !== currentNIS) return;
        if (data.sudahUjian) {
          nisError.classList.remove("d-none");
          nisError.textContent = "Anda sudah mengikuti ujian ini.";
          namaInput.value = "";
          kelasInput.value = "";
          submitBtn.disabled = true;
          submitBtn.style.opacity = "0.6";
          return;
        }
        if (data.nama) {
          namaInput.value = data.nama;
          namaInput.style.color = "#212529";
          namaInput.style.fontStyle = "normal";
          kelasInput.value = data.kelas;
          mapelInput.value = data.mapel;
          pdfFrame.src = data.url;
          mapelPassword = data.password || "";

          const examForm = document.getElementById("examForm");
          examForm.innerHTML = "";
          const jumlahSoal = parseInt(data.jumlah) || 0;

          for (let i = 1; i <= jumlahSoal; i++) {
            const questionRow = document.createElement("div");
            questionRow.classList.add("question-row");
            questionRow.innerHTML = `
              <span>${i}.</span>
              <div class="options">
                <label><input type="radio" name="soal${i}" value="A"><span class="option-dot">A</span></label>
                <label><input type="radio" name="soal${i}" value="B"><span class="option-dot">B</span></label>
                <label><input type="radio" name="soal${i}" value="C"><span class="option-dot">C</span></label>
                <label><input type="radio" name="soal${i}" value="D"><span class="option-dot">D</span></label>
              </div>
            `;
            examForm.appendChild(questionRow);
          }
          passwordInput.disabled = false;
          passwordInput.style.cursor = "text";
          submitBtn.disabled = false;
          submitBtn.style.opacity = "1";
          submitBtn.style.cursor = "pointer";
        } else {
          namaInput.value = "NIS tidak ditemukan!";
          namaInput.style.color = "#dc3545";
          namaInput.style.fontStyle = "italic";
          submitBtn.disabled = true;
        }
      } catch (error) {
        console.error("Gagal memuat data murid:", error);
        namaInput.value = "Gagal mengambil data!";
        namaInput.style.color = "#dc3545";
        submitBtn.disabled = true;
      }
    }, 700);
  });

  document.getElementById("loginForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const enteredPassword = passwordInput.value.trim();
    const nama = namaInput.value.trim();
    const kelas = kelasInput.value.trim();
    const mapel = mapelInput.value.trim();
    if (!nama || !kelas || !mapel) {
      Swal.fire({
        icon: "warning",
        title: "Data belum lengkap!",
        text: "Pastikan NIS valid dan data sudah muncul.",
        confirmButtonColor: "#007bff",
      });
      return;
    }

    if (enteredPassword !== mapelPassword) {
      passwordError.classList.remove("d-none");
      passwordInput.classList.add("shake");
      passwordInput.focus();

      setTimeout(() => passwordInput.classList.remove("shake"), 400);
      setTimeout(() => {
        passwordError.classList.add("d-none");
      }, 3000);
      return;
    }

    passwordError.classList.add("d-none");
    submitBtn.disabled = true;
    submitBtn.style.opacity = "0.6";
    submitBtn.style.cursor = "not-allowed";

    document.getElementById("userName").textContent = nama;
    document.getElementById("userClass").textContent = kelas;

    loginScreen.style.display = "none";
    examContainer.style.display = "flex";

    await goFullscreen();
    await enableWakeLock();
    resumeTimer();

    if (screen.orientation && screen.orientation.lock) {
      try {
        await screen.orientation.lock("landscape");
      } catch (err) {
        console.warn("Tidak bisa kunci orientasi:", err);
      }
    }
    checkOrientation();
  });
});
</script>
</body>
</html>
